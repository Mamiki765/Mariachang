# ワークフローの名前
name: Database Backup

# ワークフローが実行されるタイミング
on:
  # 日本時間の AM 4:00 (UTCでは前日の PM 19:00) に自動実行
  schedule:
    - cron: "0 19 * * *"

  # GitHubのActionsタブから手動で実行できるようにする
  workflow_dispatch:

# 実行される一連の処理
jobs:
  backup-and-notify:
    # 最新のUbuntu（Linux）環境で実行
    runs-on: ubuntu-latest

    # 処理のステップ
    steps:
      # 1. リポジトリのコードを仮想環境にコピーする
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. PostgreSQL 17クライアントをインストールする (★ここを差し替えました)
      - name: Install PostgreSQL Client 17
        run: |
          sudo apt-get update
          sudo apt-get install -y wget ca-certificates gnupg lsb-release

          # PostgreSQLの署名キーをダウンロードして保存（新しい推奨手順）
          wget -qO- https://www.postgresql.org/media/keys/ACCC4CF8.asc \
            | sudo tee /etc/apt/trusted.gpg.d/postgresql.asc

          # リポジトリリストに追加
          echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" \
            | sudo tee /etc/apt/sources.list.d/pgdg.list

          # 更新してインストール
          sudo apt-get update
          sudo apt-get install -y postgresql-client-17
          
          # 確認用（ログにバージョンが出ます）
          pg_dump --version

      # 3. 実際にバックアップファイルを作成する
      - name: Create Backup
        run: |
          mkdir -p backups
          # ファイル名を YYYYMMDD_HHMM 形式で生成
          FILENAME="backup_$(date +'%Y%m%d_%H%M').sql"
          # secretsからデータベースURLを読み込んでバックアップを実行
          pg_dump "${{ secrets.DATABASE_URL }}?sslmode=require" > "backups/$FILENAME"

      # 4. ファイルサイズをチェックし、結果に応じてDiscordに通知する
      - name: Check Size and Send to Discord
        run: |
          # backups/ の中にある .sql ファイル（一つしかないはず）のパスを取得
          FILE_PATH=$(ls backups/*.sql)
          # ファイルサイズをバイト単位で取得
          FILE_SIZE=$(stat -c%s "$FILE_PATH")
          # 8MBの上限をバイト単位で設定
          MAX_SIZE=8000000

          # ワークフローのトリガー（実行理由）によってメッセージを分岐させる
          if [ "${{ github.event_name }}" == "schedule" ]; then
           TRIGGER_MESSAGE="データベースの自動バックアップが完了しました。"
          else
           TRIGGER_MESSAGE="データベースの手動バックアップが完了しました。"
          fi

          # ファイルサイズが上限を超えているか判定
          if [ $FILE_SIZE -gt $MAX_SIZE ]; then
            # --- 上限を超えていた場合 ---
            # ファイルサイズをKBに変換してメッセージを作成
            SIZE_KB=$((FILE_SIZE / 1024))
            MESSAGE="バックアップ失敗: ファイルサイズが8MBの上限を超えました (約 ${SIZE_KB} KB)。"
            # JSON形式でエラーメッセージを送信
            curl -X POST -H "Content-Type: application/json" -d "{\"content\": \"$MESSAGE\"}" ${{ secrets.DISCORD_WEBHOOK_URL }}
          else
            # --- 上限以内の場合 ---
            # multipart/form-data形式でファイルと、先ほど作ったメッセージを送信
            curl -X POST -F "payload_json={\"content\": \"$TRIGGER_MESSAGE\"}" -F "file=@$FILE_PATH" ${{ secrets.DISCORD_WEBHOOK_URL }}
          fi