name: Deploy to OCI

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: SSH deploy
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.OCI_HOST }}
          username: ${{ secrets.OCI_USER }}
          key: ${{ secrets.OCI_SSH_KEY }}
          debug: true
          script: |
            set -e  # ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã‚‰æ­¢ã¾ã‚‹è¨­å®š

            # 1. ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æœ€æ–°ã«ã™ã‚‹
            echo "--- ğŸ“‚ Moving to Repo Dir ---"
            cd ~/apps/Mariachang
            echo "--- â¬‡ï¸ Git Pulling ---"
            git pull

            # 2. Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’å†æ§‹ç¯‰ã—ã¦èµ·å‹•ï¼ˆãƒãƒªã‚¢ã ã‘ï¼‰
            echo "--- ğŸ³ Docker Rebuild & Restart ---"
            cd ~/apps  # docker-compose.yml ãŒã‚ã‚‹å ´æ‰€ã«ç§»å‹•
            # --build: å¤‰æ›´ã‚’æ¤œçŸ¥ã—ã¦ä½œã‚Šç›´ã™
            # mariachang: ãƒ†ãƒ©ãƒªã‚¢ã¯å·»ãè¾¼ã¾ãšã€ãƒãƒªã‚¢ã ã‘æ›´æ–°ã™ã‚‹
            sudo docker compose up -d --build mariachang
            
            # 3. å¤ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãŠæƒé™¤ï¼ˆãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ç¯€ç´„ï¼‰
            sudo docker image prune -f

      # å¤±æ•—æ™‚ã®é€šçŸ¥
      - name: Discord Notification on Failure
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.OCI_DISCORD_WEBHOOK_URL }}
          status: ${{ job.status }}
          content: "âš ï¸ ãƒãƒªã‚¢æ§˜ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸã‚ï¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          title: "Deploy Failed"
          color: 0xff0000

      # æˆåŠŸæ™‚ã®é€šçŸ¥
      - name: Discord Notification on Success
        if: success()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.OCI_DISCORD_WEBHOOK_URL }}
          status: ${{ job.status }}
          content: "âœ… ãƒãƒªã‚¢æ§˜ã®æ›´æ–°ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚"
          title: "Deploy Success"
          color: 0x00ff00